
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>WS 4 Solution 📈 &#8212; COMSC341-CD: Causal Inference for Data Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=a37d84e8" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="application/vnd.jupyter.widget-state+json">{"state": {"2c244bf9518a4a66aa1def933b76e25f": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "bb5483b0a79c44af806abe57c0cc5ba1": {"model_name": "VBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": ["widget-interact"], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "VBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "VBoxView", "box_style": "", "children": ["IPY_MODEL_e0f5509c745941b6917bd84c8ab45f78", "IPY_MODEL_e71368ab1dbf46929a70ce08d4daf064", "IPY_MODEL_dfd0ae4bec94438dacf81ebb4aff330c"], "layout": "IPY_MODEL_2c244bf9518a4a66aa1def933b76e25f", "tabbable": null, "tooltip": null}}, "d587f1f816bd4abca6c7052797e6ffdc": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "8470a1dedf9c472d9dc6cd43ec57e065": {"model_name": "SliderStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "SliderStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "description_width": "", "handle_color": null}}, "e0f5509c745941b6917bd84c8ab45f78": {"model_name": "FloatSliderModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "FloatSliderModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "FloatSliderView", "behavior": "drag-tap", "continuous_update": true, "description": "treatment_effect", "description_allow_html": false, "disabled": false, "layout": "IPY_MODEL_d587f1f816bd4abca6c7052797e6ffdc", "max": 5.0, "min": -5.0, "orientation": "horizontal", "readout": true, "readout_format": ".2f", "step": 0.1, "style": "IPY_MODEL_8470a1dedf9c472d9dc6cd43ec57e065", "tabbable": null, "tooltip": null, "value": 0.0}}, "04fdac5e1fe64fccb108681560a67b04": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "14ff1f5f1d7b4e3da60912947157f7c7": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "e71368ab1dbf46929a70ce08d4daf064": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "Run Interact", "disabled": false, "icon": "", "layout": "IPY_MODEL_04fdac5e1fe64fccb108681560a67b04", "style": "IPY_MODEL_14ff1f5f1d7b4e3da60912947157f7c7", "tabbable": null, "tooltip": null}}, "e9e8fbd0b35046b58feb76bc295a5d26": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "dfd0ae4bec94438dacf81ebb4aff330c": {"model_name": "OutputModel", "model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_e9e8fbd0b35046b58feb76bc295a5d26", "msg_id": "", "outputs": [], "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}</script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script crossorigin="anonymous" data-jupyter-widgets-cdn="https://cdn.jsdelivr.net/npm/" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.6/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'worksheets/ws4_solution';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">COMSC341-CD: Causal Inference for Data Science</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Causal Inference for Data Science
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Syllabus</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../syllabus/values.html">Goals and Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syllabus/policies.html">Course Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syllabus/schedule.html">Schedule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syllabus/office_hours.html">Office Hours</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../resources/submit.html">How to Run and Submit</a></li>


<li class="toctree-l1"><a class="reference internal" href="../resources/catalog.html">Causal Catalog</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Worksheets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ws1.html">Worksheet 1 🎲</a></li>






<li class="toctree-l1"><a class="reference internal" href="ws2.html">Worksheet 2 🐼</a></li>






<li class="toctree-l1"><a class="reference internal" href="ws3.html">Worksheet 3 📊</a></li>







<li class="toctree-l1"><a class="reference internal" href="ws4.html">Worksheet 4 📈</a></li>







<li class="toctree-l1"><a class="reference internal" href="ws5.html">Worksheet 5 🌱</a></li>







<li class="toctree-l1"><a class="reference internal" href="ws6.html">Worksheet 6 🤖</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../projects/proj1.html">Project 1 👶</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/proj2.html">Project 2 👥</a></li>

<li class="toctree-l1"><a class="reference internal" href="../projects/proj3.html">Project 3 💉</a></li>

<li class="toctree-l1"><a class="reference internal" href="../projects/final_project.html">Final Project 🌍</a></li>






</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://comsc341cd-hub-sp.mtholyoke.edu/hub/user-redirect/git-pull?repo=https%3A//github.com/comsc341cd/comsc341cd.github.io&urlpath=tree/comsc341cd.github.io/worksheets/ws4_solution.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/worksheets/ws4_solution.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>WS 4 Solution 📈</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">WS 4 Solution 📈</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#statsmodels-1-pt">1. Statsmodels [1 pt]</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-statsmodels-to-fit-linear-regression-models">Using statsmodels to fit linear regression models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">1.1</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-regression-coefficients">Interpreting regression coefficients</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">1.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">1.4</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-regression-for-treatment-effect-estimation-1-pt">2. Linear regression for treatment effect estimation [1 pt]</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2.2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#to-adjust-or-not-to-adjust-1-5-pts">3. To adjust or not to adjust? [1.5 pts]</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-austin-2011-1-pt">4. Reading: Austin 2011 [1 pt]</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reflection-0-5-pts">5. Reflection [0.5 pts]</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="ws-4-solution">
<span id="ws4-solution"></span><h1>WS 4 Solution 📈<a class="headerlink" href="#ws-4-solution" title="Link to this heading">#</a></h1>
<blockquote class="epigraph">
<div><p>Regression and causal graphs</p>
<p class="attribution">—TODO your name here</p>
</div></blockquote>
<div class="admonition-collaboration-statement admonition">
<p class="admonition-title">Collaboration Statement</p>
<ul class="simple">
<li><p>TODO brief statement on the nature of your collaboration.</p></li>
<li><p>TODO your collaborator’s names here</p></li>
</ul>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="learning-objectives">
<h1>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Become familiar with the <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> library for running regression models</p></li>
<li><p>Understand the relationship between the regression coefficient for a treatment variable and the average treatment effect</p></li>
<li><p>Practice determining when adjustment is needed vs when it is not given a DAG</p></li>
<li><p>Read and reflect on a technical article introducing propensity scores as an observational study technique</p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="statsmodels-1-pt">
<h1>1. Statsmodels [1 pt]<a class="headerlink" href="#statsmodels-1-pt" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://www.statsmodels.org/stable/index.html">statsmodels</a> is a popular Python library for statistical modeling and analysis. It provides a wide range of statistical models and functions similar to what you might find in R. We’ll use statsmodels throughout the worksheet and in the upcoming classes to fit regression models.</p>
<p>Like matplotlib and seaborn, statsmodels has an extensive API with many different ways to achieve the same result. For the course, we’ll work primarily with the <code class="docutils literal notranslate"><span class="pre">formula.api</span></code> submodule for integration with pandas DataFrames and the <a class="reference external" href="https://patsy.readthedocs.io/en/latest/">patsy</a> syntax for specifying regression formulas. The following official user guide is a good starting reference for how we’ll primarily be using statsmodels:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.statsmodels.org/stable/example_formulas.html">Fitting models using R-style formulas</a></p></li>
</ul>
<p>First, let’s import the statsmodels library using the standard alias <code class="docutils literal notranslate"><span class="pre">smf</span></code> (<strong>s</strong>tats<strong>m</strong>odels <strong>f</strong>ormula) for the formula API, along with the other data science modules we have been using:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact_manual</span>

<span class="c1"># standard import alias for the statsmodels formula API</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<section id="using-statsmodels-to-fit-linear-regression-models">
<h2>Using statsmodels to fit linear regression models<a class="headerlink" href="#using-statsmodels-to-fit-linear-regression-models" title="Link to this heading">#</a></h2>
<p>Up until this point in class, we have been estimating various versions of conditional expectations of the form:</p>
<div class="math notranslate nohighlight">
\[
E[Y | X]
\]</div>
<p>For example, we have calculated the conditional expectation of the outcome given a particular treatment value <span class="math notranslate nohighlight">\(t\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\hat{E}[Y | T=t]
\]</div>
<p>As well as the conditional expectation of the outcome given particular treatment and covariate values <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(x\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\hat{E}[Y | T=t, X=x]
\]</div>
<p>These are all useful calculations, but they only tell us about the conditional expectation of the outcome given particular treatment and covariate values. What if <span class="math notranslate nohighlight">\(X\)</span> was continuous, and we wanted to know the effect of <span class="math notranslate nohighlight">\(T\)</span> on <span class="math notranslate nohighlight">\(Y\)</span> across all values of <span class="math notranslate nohighlight">\(X\)</span>?</p>
<p>This is where <strong>line fitting</strong> via linear regression is useful. Under certain statistical assumptions, we can actually model the conditional expectation. Fitting the following linear regression model, where the <span class="math notranslate nohighlight">\(\beta\)</span> values are the <strong>regression coefficients</strong> that we will estimate from our data:</p>
<div class="math notranslate nohighlight">
\[
Y= \beta_0 + \beta_1 T
\]</div>
<p>actually gives us the following estimated conditional expectation:</p>
<div class="math notranslate nohighlight">
\[
E[Y | T] = \beta_0 + \beta_1 T
\]</div>
<p>And if we have multiple covariates, we can fit the following model:</p>
<div class="math notranslate nohighlight">
\[
Y= \beta_0 + \beta_1 T + \beta_2 X
\]</div>
<p>which gives us the following conditional expectation:</p>
<div class="math notranslate nohighlight">
\[
E[Y | T, X] = \beta_0 + \beta_1 T + \beta_2 X
\]</div>
<p>When we set the covariates to particular <span class="math notranslate nohighlight">\(T=t\)</span> and <span class="math notranslate nohighlight">\(X=x\)</span> values, we get the conditional expectation of the outcome given those values:</p>
<div class="math notranslate nohighlight">
\[
E[Y | T=t] = \beta_0 + \beta_1 t
\]</div>
<div class="math notranslate nohighlight">
\[
E[Y | T=t, X=x] = \beta_0 + \beta_1 t + \beta_2 x
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike the causal study design assumptions we have been discussing, we won’t cover the assumptions that make linear regression a valid model for the conditional expectations. For now, we’ll take linear regression correctly modelling conditional expectations as a given and focus on how to fit and interpret the regression coefficients. If you are curious and want to learn more about the properties of linear regression, see the following resource:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://mixtape.scunning.com/02-probability_and_regression#population-model">Chapters 2.11 - 2.25</a> of Causal Inference: The Mixtape</p></li>
</ul>
</div>
<p>Let’s take a look at how to use statsmodels to fit a line to some data. We’ll load in the same gapminder data from Worksheet 3 and fit a line to the relationship between life expectancy and GDP per capita for countries in Europe in 2007.</p>
<section id="id1">
<h3>1.1<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>First, let’s select the data for Europe in 2007 and visualize the relationship between life expectancy <code class="docutils literal notranslate"><span class="pre">lifeExp</span></code> and GDP per capita <code class="docutils literal notranslate"><span class="pre">gdpPercap</span></code> using a scatter plot. The data should roughly follow a linear relationship, with some spread:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gapminder_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;~/COMSC-341CD/data/gapminder.csv&quot;</span><span class="p">)</span>

<span class="c1"># TODO select the gapminder data for Europe in 2007</span>
<span class="n">selected_df</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">selected_df</span> <span class="o">=</span> <span class="n">gapminder_df</span><span class="p">[</span><span class="n">gapminder_df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2007</span><span class="p">]</span>
<span class="n">selected_df</span> <span class="o">=</span> <span class="n">selected_df</span><span class="p">[</span><span class="n">selected_df</span><span class="p">[</span><span class="s2">&quot;continent&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Europe&quot;</span><span class="p">]</span>
<span class="c1">### END SOLUTION</span>

<span class="c1"># TODO show the scatter plot between &#39;gdpPercap&#39; and &#39;lifeExp&#39;</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">selected_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;gdpPercap&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;lifeExp&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;GDP per capita vs. life expectancy in 2007 for Europe&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;GDP per capita (USD)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Life expectancy (years)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2d9629f0154f37afc3cc68ad24c4d4ead15157fd73f9760da70a5ea1589d3cd2.png" src="../_images/2d9629f0154f37afc3cc68ad24c4d4ead15157fd73f9760da70a5ea1589d3cd2.png" />
</div>
</div>
<p>Let’s now fit a line to this data using a statsmodels formula.</p>
<p>We can specify the linear regression we want to fit using a string describing the formula. The formula is specified in the format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;outcome ~ 1 + covariate1 + covariate2 + ...&#39;</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">outcome</span></code> is the dependent variable (the outcome or “y” we want to predict)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> is the constant term (the intercept)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">covariate1</span></code>, <code class="docutils literal notranslate"><span class="pre">covariate2</span></code>, etc. are the independent variables (the “x”s we use to predict the outcome)</p></li>
</ul>
<p>This string formula is then passed into the <code class="docutils literal notranslate"><span class="pre">smf.ols</span></code> (<strong>o</strong>rdinary <strong>l</strong>east <strong>s</strong>quares) function to fit the model. What is convenient is that we can pass in the pandas DataFrame containing the data directly to the function as the <code class="docutils literal notranslate"><span class="pre">data</span></code> argument, and the formula will be applied to the DataFrame column names. For example, if we have a DataFrame <code class="docutils literal notranslate"><span class="pre">df</span></code> with columns <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">x1</span></code>, and <code class="docutils literal notranslate"><span class="pre">x2</span></code>, the formula <code class="docutils literal notranslate"><span class="pre">'y</span> <span class="pre">~</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">x1</span> <span class="pre">+</span> <span class="pre">x2'</span></code> will fit a linear regression model with those columns to the data. The code that corresponds to this is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">formula</span>  <span class="o">=</span> <span class="s1">&#39;y ~ 1 + x1 + x2&#39;</span>
<span class="n">linear_reg_results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
<p>Let’s try this out on our gapminder data:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lifeExp</span></code> is the outcome variable</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gdpPercap</span></code> is the independent variable</p></li>
<li><p>include a constant term in the model by adding a <code class="docutils literal notranslate"><span class="pre">1</span></code> to the formula</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO fit the linear regression model with the formula above</span>
<span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">linear_reg_results</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;lifeExp ~ 1 + gdpPercap&#39;</span>
<span class="n">linear_reg_results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">selected_df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
</div>
<p>We can examine the fitted <span class="math notranslate nohighlight">\(\beta\)</span> values using the <code class="docutils literal notranslate"><span class="pre">params</span></code> attribute of the fitted model object, which returns a pd.Series of the coefficients:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO print the fitted coefficients</span>
<span class="c1"># print(linear_reg_results.params)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also call the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method on the fitted model object to get predictions on a DataFrame of values that match the column names in the original data.</p>
<p>Let’s apply this to a range of GDP per capita values to get the fitted life expectancy values to plot the fitted line. Use the <a class="reference external" href="https://numpy.org/doc/2.1/reference/generated/numpy.linspace.html">np.linspace</a> function to generate a list of <code class="docutils literal notranslate"><span class="pre">num=1000</span></code> evenly spaced values, starting at the minimum and ending at the maximum GDP per capita <code class="docutils literal notranslate"><span class="pre">gdpPercap</span></code> values in the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO generate evenly spaced values</span>
<span class="c1"># x_values = np.linspace(start=TODO, stop=TODO, num=TODO)</span>

<span class="c1"># TODO save the predicted values, using the same column name as the original data</span>
<span class="c1"># y_values = linear_reg_results.predict(</span>
<span class="c1">#     pd.DataFrame({&quot;gdpPercap&quot;: x_values})</span>
<span class="c1"># )</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">selected_df</span><span class="p">[</span><span class="s2">&quot;gdpPercap&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">stop</span><span class="o">=</span><span class="n">selected_df</span><span class="p">[</span><span class="s2">&quot;gdpPercap&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">y_values</span> <span class="o">=</span> <span class="n">linear_reg_results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;gdpPercap&quot;</span><span class="p">:</span> <span class="n">x_values</span><span class="p">}))</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s visualize the scatter plot of the original data and the fitted line on the same plot.</p>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">sns.lineplot()</span></code> function to plot the fitted line, passing in the <code class="docutils literal notranslate"><span class="pre">x_values</span></code> and <code class="docutils literal notranslate"><span class="pre">y_values</span></code> as the <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> arguments respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO plot the original data and the fitted line</span>
<span class="c1">### BEGIN SOLUTION</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">selected_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;gdpPercap&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;lifeExp&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;GDP per capita vs. life expectancy in 2007 for Europe&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;GDP per capita (USD)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Life expectancy (years)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/69c735411c86581bef61dc3814f2a85a1fbed32a99ab6243a5b11aa9258b0c72.png" src="../_images/69c735411c86581bef61dc3814f2a85a1fbed32a99ab6243a5b11aa9258b0c72.png" />
</div>
</div>
</section>
</section>
<section id="interpreting-regression-coefficients">
<h2>Interpreting regression coefficients<a class="headerlink" href="#interpreting-regression-coefficients" title="Link to this heading">#</a></h2>
<section id="id2">
<h3>1.2<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>In order to use linear regression for causal inference, we’ll need to pay close attention to the interpretation of the regression coefficients.</p>
<p>In general, the regression coefficient <span class="math notranslate nohighlight">\(\beta_1\)</span> for a covariate <span class="math notranslate nohighlight">\(X_1\)</span> can be interpreted as the expected change in the outcome <span class="math notranslate nohighlight">\(Y\)</span> for a <strong>one unit change</strong> in <span class="math notranslate nohighlight">\(X_1\)</span>, holding all other covariates constant.</p>
<p>For example, suppose we have a linear regression model fitting the relationship between coffee price <span class="math notranslate nohighlight">\(Y\)</span> in dollars per pound ($/lb) and global temperature in celcius <span class="math notranslate nohighlight">\(X_1\)</span> and coffee species <span class="math notranslate nohighlight">\(X_2\)</span> (0 = robusta, 1 = arabica):</p>
<div class="math notranslate nohighlight">
\[
Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2
\]</div>
<p>The regression coefficient <span class="math notranslate nohighlight">\(\beta_1\)</span> can be interpreted as the associated expected change in coffee price <span class="math notranslate nohighlight">\(Y\)</span> for a <strong>one degree Celsius increase</strong> in global temperature <span class="math notranslate nohighlight">\(X_1\)</span>, holding the coffee species <span class="math notranslate nohighlight">\(X_2\)</span> constant. If <span class="math notranslate nohighlight">\(\beta_1 = 3\)</span>, we can interpret this as:</p>
<blockquote>
<div><p>In the collected data, the price of coffee is associated with an increase of $3 per pound for each degree Celsius increase in global temperature, while holding the coffee species constant.</p>
</div></blockquote>
<p>Since a fitted regression is linear, we can also scale the units of <span class="math notranslate nohighlight">\(X_1\)</span> to be different. For example, we could interpret <span class="math notranslate nohighlight">\(2*\beta_1\)</span> as the associated expected change in coffee price <span class="math notranslate nohighlight">\(Y\)</span> for a <strong>two degree Celsius increase</strong> in global temperature <span class="math notranslate nohighlight">\(X_1\)</span>, holding the coffee species <span class="math notranslate nohighlight">\(X_2\)</span> constant, or even convert the units to Fahrenheit in stead of Celsius.</p>
<p>Let’s now interpret the regression coefficients for our gapminder data. Multiply the <code class="docutils literal notranslate"><span class="pre">gdpPercap</span></code> coefficient by 1000 to convert the units to thousands of dollars, and interpret the new coefficient for the <code class="docutils literal notranslate"><span class="pre">gdpPercap</span></code> variable. In your response, be sure to include the year and selected continent of the data used to fit the model.</p>
<p><strong>Your Response</strong>: For European countries in 2007, a $1000 increase in GDP per capita is associated with a 0.215 year increase in life expectancy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO use this cell to scale the gdpPercap coefficient by 1000 and interpret the new coefficient</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="nb">print</span><span class="p">(</span><span class="n">linear_reg_results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;gdpPercap&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2146340344675842
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>1.3<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>A common transformation applied to variables in linear regression models is to take the natural logarithm of the variable, which does two things:</p>
<ul class="simple">
<li><p>it often helps make the variables “better-behaved” (e.g. more like a normal distribution)</p></li>
<li><p>it also changes the interpretation of the regression coefficients.</p></li>
</ul>
<p>Let’s apply this transformation to the <code class="docutils literal notranslate"><span class="pre">gdpPercap</span></code> and <code class="docutils literal notranslate"><span class="pre">lifeExp</span></code> variables, and interpret the new regression coefficients.</p>
<p>First, create new columns in the  <strong>full</strong> <code class="docutils literal notranslate"><span class="pre">gapminder_df</span></code> DataFrame containing the log-transformed variables by applying the <code class="docutils literal notranslate"><span class="pre">np.log()</span></code> function to the <code class="docutils literal notranslate"><span class="pre">gdpPercap</span></code> and <code class="docutils literal notranslate"><span class="pre">lifeExp</span></code> columns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO create new columns in the original gapminder_df DataFrame containing the log-transformed variables</span>
<span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;log_gdpPercap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;log_lifeExp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;log_gdpPercap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;gdpPercap&#39;</span><span class="p">])</span>
<span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;log_lifeExp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;lifeExp&#39;</span><span class="p">])</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
</div>
<p>Next, let’s plot the histograms of the original and log-transformed ‘gdpPercap’ side-by-side to to see the effect of the transformation.</p>
<p>To create the side-by-side plot, we use the <a class="reference external" href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplots.html">plt.subplots()</a> function to create a figure with two subplots. This function has many optional arguments for figure size, layout, etc. that we can use to customize the plot, but the primary arguments we need to specify are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nrows</span></code>: the number of rows in the figure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ncols</span></code>: the number of columns in the figure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">figsize</span></code>: the size of the figure, which takes a tuple of the figure <code class="docutils literal notranslate"><span class="pre">(width,</span> <span class="pre">height)</span></code> in inches</p></li>
</ul>
<p>This then returns a <code class="docutils literal notranslate"><span class="pre">(fig,</span> <span class="pre">axs)</span></code> tuple, where <code class="docutils literal notranslate"><span class="pre">fig</span></code> is the figure object and <code class="docutils literal notranslate"><span class="pre">axs</span></code> is an array of the axes objects.
We can think of the <code class="docutils literal notranslate"><span class="pre">fig</span></code> object as the overall figure, and the <code class="docutils literal notranslate"><span class="pre">axs</span></code> array corresponding to the individual subplots.</p>
<p>For example, if we want to create a figure with 1 row and 2 columns, we can make the following <code class="docutils literal notranslate"><span class="pre">plt.subplots()</span></code> call. Then, we can plot on the first subplot using <code class="docutils literal notranslate"><span class="pre">axs[0]</span></code> and the second subplot using <code class="docutils literal notranslate"><span class="pre">axs[1]</span></code>, as well as set the title and axis labels for each subplot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO run this cell to see an example of the `plt.subplots()` function</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of subplots:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">))</span>

<span class="c1"># axs[0] is the first (left) subplot, axs[1] is the second (right) subplot</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x=0.5 on first subplot&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y=0.5 on second subplot&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>

<span class="c1"># We can individually set the title and axis labels for each subplot</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;First subplot&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Second subplot&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;First subplot x-axis&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Second subplot x-axis&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># We can also set the title for the entire figure </span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Overall title for the figure&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>number of subplots: 2
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;Overall title for the figure&#39;)
</pre></div>
</div>
<img alt="../_images/5c98301b2828bf60bdd1918dc9d77fd2fd00c9a5d4a728a1747daaf5ac2b7a59.png" src="../_images/5c98301b2828bf60bdd1918dc9d77fd2fd00c9a5d4a728a1747daaf5ac2b7a59.png" />
</div>
</div>
<p>Seaborn again provides convenient intergration with matplotlib, as most seaborn plotting functions have an optional <code class="docutils literal notranslate"><span class="pre">ax</span></code> argument that we can use to plot on a specific axis.</p>
<p>Let’s create the side-by-side plot of the histograms of the original and log-transformed ‘gdpPercap’ variables using
<a class="reference external" href="https://seaborn.pydata.org/generated/seaborn.histplot.html">sns.histplot()</a> and the <code class="docutils literal notranslate"><span class="pre">ax</span></code> argument to plot on specific axes. The tranformed data should look more “normally distributed” than the original data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO generate subplots with 1 row and 2 columns, figsize=(12,6)</span>
<span class="c1"># fig, axs = plt.subplots(nrows=None, ncols=None, figsize=None)</span>

<span class="c1"># TODO plot the histograms of the original &#39;gdpPercap&#39; variable on the first subplot by using the `ax` argument</span>
<span class="c1"># sns.histplot(x=TODO, ax=TODO)</span>

<span class="c1"># TODO plot the histogram of the log-transformed &#39;log_gdpPercap&#39; variable on the second subplot by using the `ax` argument</span>
<span class="c1"># sns.histplot(x=TODO, ax=TODO)</span>


<span class="c1">### BEGIN SOLUTION</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;gdpPercap&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">gapminder_df</span><span class="p">[</span><span class="s1">&#39;log_gdpPercap&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;GDP per capita (USD)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Log GDP per capita (USD)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;GDP per capita for all countries&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Log GDP per capita for all countries&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;GDP per capita for all countries&quot;</span><span class="p">)</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;GDP per capita for all countries&#39;)
</pre></div>
</div>
<img alt="../_images/886179c3badfed19ba00b26a67ee8052ac36e99468c1f094a2c77b9d2b5090fb.png" src="../_images/886179c3badfed19ba00b26a67ee8052ac36e99468c1f094a2c77b9d2b5090fb.png" />
</div>
</div>
</section>
<section id="id4">
<h3>1.4<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>Let’s now fit a linear regression model to the log-transformed data. When both the outcome and covariate are log-transformed, the regression coefficient can be interpreted as approximately the <strong>percentage change</strong> in the outcome for a <strong>one percent change</strong> in the covariate (this is also known as the <strong>elasticity</strong> in economics). For example, in our coffee price example above, if we instead fit the model:</p>
<div class="math notranslate nohighlight">
\[
\log(Y) = \beta_0 + \beta_1 \log(X_1) + \beta_2 X_2
\]</div>
<p>And <span class="math notranslate nohighlight">\(\beta_1 = 2.5\)</span>, we can interpret this as:</p>
<blockquote>
<div><p>In the collected data, the price of coffee is associated with a price per pound increase of 2.5% for each 1% increase in global temperature, while holding the coffee species constant.</p>
</div></blockquote>
<p>Let’s now fit a linear regression model to the log-transformed data and interpret the regression coefficients. Specifically, fit the model on the entire <code class="docutils literal notranslate"><span class="pre">gapminder_df</span></code> DataFrame, and interpret the regression coefficient for the <code class="docutils literal notranslate"><span class="pre">log_gdpPercap</span></code> variable:</p>
<div class="math notranslate nohighlight">
\[
\log(\text{lifeExp}) = \beta_0 + \beta_1 \log(\text{gdpPercap})
\]</div>
<p><strong>Your Response</strong>: Among all countries in the gapminder dataset across all years, an 1% increase in GDP per capita is associated with a 0.15% increase in life expectancy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO fit the linear regression model to the log-transformed data</span>
<span class="n">log_formula</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">log_reg_results</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">log_formula</span> <span class="o">=</span> <span class="s1">&#39;log_lifeExp ~ 1 + log_gdpPercap&#39;</span>
<span class="n">log_reg_results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">log_formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gapminder_df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_reg_results</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept        2.864177
log_gdpPercap    0.146549
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="linear-regression-for-treatment-effect-estimation-1-pt">
<h1>2. Linear regression for treatment effect estimation [1 pt]<a class="headerlink" href="#linear-regression-for-treatment-effect-estimation-1-pt" title="Link to this heading">#</a></h1>
<p>Now that we have seen how to fit linear regression models and interpret the regression coefficients, let’s see how we can use linear regression to estimate causal effects. An advantage of linear regression for estimating causal effects is that it makes “controlling for” many covariates straightforward. For example, if we have a treatment variable <span class="math notranslate nohighlight">\(T\)</span> and a set of variables <span class="math notranslate nohighlight">\(X = \{X_1, X_2, X_3 \}\)</span> that satisfies the backdoor criterion we want to control for, we can fit the model:</p>
<div class="math notranslate nohighlight">
\[
Y = \beta_0 + \beta_1 T + \beta_2 X_1 + \beta_3 X_2 + \beta_4 X_3
\]</div>
<p>This generalizes to any number of covariates (though we still need to be careful about positivity violations!).</p>
<section id="id5">
<h2>2.1<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>First, let’s write a general function that fits a linear regression model to the data with a given treatment variable and covariates list, and returns the fitted model results object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a linear regression model to the data with a given treatment variable and optional covariates list,</span>
<span class="sd">    returning the fitted coefficients.</span>

<span class="sd">    Assumes that the treatment column is binary, and that the covariates are all continuous.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (pd.DataFrame): The data to fit the model to.</span>
<span class="sd">        outcome (str): The outcome variable.</span>
<span class="sd">        treatment (str): The treatment variable.</span>
<span class="sd">        covariates (list[str]): The covariates to control for, defaults to None</span>

<span class="sd">    Returns:</span>
<span class="sd">        smf.OLSResults: The fitted model results object, which is the output of the `smf.ols()` function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;Outcome variable not found in data&quot;</span>
    <span class="k">assert</span> <span class="n">treatment</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;Treatment variable not found in data&quot;</span>

    <span class="c1"># TODO complete this function, be sure to handle the case where covariates is None!</span>
    <span class="k">pass</span>

    <span class="c1">### BEGIN SOLUTION</span>
    <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outcome</span><span class="si">}</span><span class="s2"> ~ 1 + </span><span class="si">{</span><span class="n">treatment</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outcome</span><span class="si">}</span><span class="s2"> ~ 1 + </span><span class="si">{</span><span class="n">treatment</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s now look at the relationship between the regression coefficient for our binary treatment variable and the difference-in-means estimate we’ve been looking at so far in the course. Below is a simplified version of the <code class="docutils literal notranslate"><span class="pre">sim_random_experiment()</span></code> function we used in Project 1, which simulates a random experiment with a binary treatment variable and a continuous outcome variable and returns a dataframe with the outcome and treatment variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sim_random_experiment</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">treatment_effect</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate a random experiment with a binary treatment.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_samples (int): the number of samples to simulate</span>
<span class="sd">        treatment_effect (float): the magnitude of the effect of the treatment on the outcome</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: a dataframe with the outcome and treatment variables:</span>
<span class="sd">            - Y: the observed outcome</span>
<span class="sd">            - T: the binary treatment assignment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate potential outcomes</span>
    <span class="n">Y0</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="n">Y0</span> <span class="o">+</span> <span class="n">treatment_effect</span>

    <span class="c1"># Randomly assign treatment</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="c1"># Generate the observed outcome</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">T</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h2>2.2<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>We’ll begin by visualizing the data generated by the <code class="docutils literal notranslate"><span class="pre">sim_random_experiment()</span></code> function using a <a class="reference external" href="https://seaborn.pydata.org/generated/seaborn.swarmplot.html">sns.swarmplot()</a>, which is similar to a categorical <a class="reference external" href="https://seaborn.pydata.org/generated/seaborn.scatterplot.html">sns.scatterplot()</a> but ensures that the points are not overlapping to better visualize the distribution. Specifically, for the swarmplot, set the <code class="docutils literal notranslate"><span class="pre">x</span></code> argument to the treatment variable <code class="docutils literal notranslate"><span class="pre">T</span></code> to visualize the distribution of the outcome <code class="docutils literal notranslate"><span class="pre">Y</span></code> by treatment assignment, and set the <code class="docutils literal notranslate"><span class="pre">hue</span></code> argument to the treatment variable <code class="docutils literal notranslate"><span class="pre">T</span></code> to color the points by treatment assignment. The alpha argument is set to 0.5 to make the points more transparent.</p>
<p>Additionally, annotate the plot with the mean of the outcome for the treatment and control groups. This should be two horizontal lines, which can be done using the <code class="docutils literal notranslate"><span class="pre">ax.axhline()</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">sim_random_experiment</span><span class="p">()</span>
<span class="c1"># TODO generate the swarmplot</span>
<span class="c1"># sns.swarmplot(data=data, x=TODO, y=TODO, hue=TODO, alpha=0.5)</span>

<span class="c1"># TODO annotate the plot with the mean of the outcome for the treatment and control groups</span>
<span class="c1"># plt.axhline(y=TODO, color=&#39;orange&#39;, label=TODO)</span>
<span class="c1"># plt.axhline(y=TODO, color=&#39;blue&#39;, label=TODO)</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of outcome by treatment assignment from simulation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatment Mean&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Control Mean&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ae5da1336f2d4c81fcb4a07aa67d0bc6dc47533b77b31737f6a0684138e06856.png" src="../_images/ae5da1336f2d4c81fcb4a07aa67d0bc6dc47533b77b31737f6a0684138e06856.png" />
</div>
</div>
<p>Next, use your <code class="docutils literal notranslate"><span class="pre">fit_linear_regression()</span></code> function to fit a linear regression model to the simulated data, and plot the fitted line on the swarmplot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO fit the linear regression model</span>
<span class="n">treat_reg_results</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># TODO predict on T=0 and T=1</span>
<span class="n">x_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">x_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">x_values</span><span class="p">})</span>
<span class="n">y_values</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># TODO plot the fitted line on the swarmplot -- you can copy the code from above into this cell</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="n">treat_reg_results</span> <span class="o">=</span> <span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
<span class="n">x_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>
<span class="n">y_values</span> <span class="o">=</span> <span class="n">treat_reg_results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_df</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of outcome by treatment assignment from simulation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatment Mean&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Control Mean&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_df</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># sns.lineplot(x=&quot;T&quot;, y=&quot;Y&quot;, data=data, color=&quot;red&quot;)</span>
<span class="c1"># plt.show()</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7d86b6009a66cc6bce467e6adc1cf17f8aaffe75ef96e47ef12258f06bbab97c.png" src="../_images/7d86b6009a66cc6bce467e6adc1cf17f8aaffe75ef96e47ef12258f06bbab97c.png" />
</div>
</div>
<p>Finally, copy your plotting code from above and add an <code class="docutils literal notranslate"><span class="pre">interact_manual</span></code> decorator to the <code class="docutils literal notranslate"><span class="pre">plot_treat_regression</span></code> function below. Specifically, add a slider to control the <code class="docutils literal notranslate"><span class="pre">treatment_effect</span></code> parameter with a range from -5 to 5:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO add an interactive_manual decorator to the `plot_treat_regression` function</span>
<span class="c1">### BEGIN SOLUTION</span>
<span class="nd">@interact_manual</span><span class="p">(</span><span class="n">treatment_effect</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
<span class="c1">### END SOLUTION</span>
<span class="k">def</span> <span class="nf">plot_treat_regression</span><span class="p">(</span><span class="n">treatment_effect</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sim_random_experiment</span><span class="p">(</span><span class="n">treatment_effect</span><span class="o">=</span><span class="n">treatment_effect</span><span class="p">)</span>

    <span class="c1"># TODO copy your plotting code from above into this cell</span>

    <span class="c1">### BEGIN SOLUTION</span>
    <span class="c1"># TODO fit the linear regression model</span>
    <span class="n">treat_reg_results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO predict on T=0 and T=1</span>
    <span class="n">x_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">x_values</span><span class="p">})</span>
    <span class="n">y_values</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">treat_reg_results</span> <span class="o">=</span> <span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
    <span class="n">x_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>
    <span class="n">y_values</span> <span class="o">=</span> <span class="n">treat_reg_results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_df</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of outcome by treatment assignment from simulation&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatment Mean&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Control Mean&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_df</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "bb5483b0a79c44af806abe57c0cc5ba1"}</script></div>
</div>
<p>The linear regression model we’ve fitted is:</p>
<div class="math notranslate nohighlight">
\[
E[Y | T] = \beta_0 + \beta_1 T
\]</div>
<p><span class="math notranslate nohighlight">\(\beta_1\)</span> is the regression coefficient for the treatment variable <span class="math notranslate nohighlight">\(T\)</span> and can also be interpreted as the slope of the line we’ve fitted. After trying out different values of the <code class="docutils literal notranslate"><span class="pre">treatment_effect</span></code> parameter in your interactive plot above, what relationship do you see between the slope of the line and the two means in the plot? What does this tell us about the relationship between the regression coefficient and the difference-in-means estimate?</p>
<p><strong>Your Response</strong>: In the interactive plot, the slope of the line is equal to difference-in-means estimate of the treatment effect, which corresponds to <span class="math notranslate nohighlight">\(\beta_1\)</span> in the model we’ve fitted.</p>
<div class="dropdown admonition">
<p class="admonition-title">Takeaway (click this once you’ve completed the section)</p>
<p>This now ties back to our interpretation of the regression coefficient in part 1 of the worksheet – the regression coefficient <span class="math notranslate nohighlight">\(\beta_1\)</span> can be interpreted as the change in the outcome for a one unit change in the treatment, holding all other variables constant. Since the treatment is binary, a one unit change in the treatment is from 0 to 1, so the regression coefficient is equal to the difference in the outcome between the treatment and control groups.</p>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Math derivation (click this once you’ve completed the section)</p>
<p>If we assume the same assumptions that allow for identification of the causal effect in a randomized experiment, and we assume that we can model the conditional expectation of the outcome given the treatment as:</p>
<div class="math notranslate nohighlight">
\[
E[Y | T] = \beta_0 + \beta_1 T
\]</div>
<p>then the regression coefficient <span class="math notranslate nohighlight">\(\beta_1\)</span> is equal to the ATE: <span class="math notranslate nohighlight">\(E[Y(1) - Y(0)]\)</span>.</p>
<p>To see this, we have:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
E[Y(1)] = E[Y(1) | T=1] = E[Y | T=1] \\
E[Y(0)] = E[Y(0) | T=0] = E[Y | T=0]
\end{split}\]</div>
<p>then plugging in the regression model, we get:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
E[Y | T=1] &amp;= \beta_0 + \beta_1 \times 1 = \beta_0 + \beta_1 \\
E[Y | T=0] &amp;= \beta_0 + \beta_1 \times 0 = \beta_0
\end{align*}
\end{split}\]</div>
<p>Finally, plugging in those values for the ATE, we get:</p>
<div class="math notranslate nohighlight">
\[
ATE = E[Y(1) - Y(0)] = E[Y(1)] - E[Y(0)] = (\beta_0 + \beta_1) - \beta_0 = \beta_1
\]</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="to-adjust-or-not-to-adjust-1-5-pts">
<h1>3. To adjust or not to adjust? [1.5 pts]<a class="headerlink" href="#to-adjust-or-not-to-adjust-1-5-pts" title="Link to this heading">#</a></h1>
<p>Let’s now utilize linear regression to control for multiple convariates, and practice determining which covariates to adjust for via the backdoor criterion. To do so, we’ll analyze some toy datasets generated from different DAGs. Since the datasets have been simulated, the true treatment effects are known – work through the following questions before clicking the dropdown at the end of the section to check whether you got the treatment effect estimates correct.</p>
<section id="id7">
<h2>3.1<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<p>Here is our first DAG that we’ll analyze:</p>
<p><img alt="" src="../_images/ws4_dag1.png" /></p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">fit_linear_regression()</span></code> function you wrote in the previous section, fit a linear regression model with the specified covariates:</p>
<p>What is the estimated ATE if we fit a linear regression model with just the treatment and outcome?</p>
<p><strong>Your Response</strong>: The estimated ATE is -0.85 when only using treatment to fit the outcome.</p>
<p>What variables satisfy the backdoor criterion and should we adjust for? Adjust for these by including them in the <code class="docutils literal notranslate"><span class="pre">covariates</span></code> argument of the <code class="docutils literal notranslate"><span class="pre">fit_linear_regression()</span></code> function. What is your estimated ATE when including these variables?</p>
<p><strong>Your Response</strong>: We need to adjust for X1, X2, X3, and <strong>not</strong> adjust for X4. If we only include X1, X2, and X3 the estimated ATE is -4.99.</p>
<p>What variable(s) should we not adjust for? Identify what kind of variable(s) they are (mediator, collider, or confounder). What is the estimated ATE if you include these variable(s) in the adjustment set as well?</p>
<p><strong>Your Response</strong>: X4 is a collider, so we should not adjust for it. If we include X4 in our adjustment set, the estimated ATE shifts to -3.01.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;~/COMSC-341CD/data/ws4_dag1.csv&quot;</span><span class="p">)</span>

<span class="c1"># TODO use `fit_linear_regression()` to fit a linear regression model with just the treatment and outcome</span>
<span class="c1">#print(fit_linear_regression(data=dag1_df, outcome=&quot;Y&quot;, treatment=&quot;T&quot;).params)</span>

<span class="c1"># TODO use `fit_linear_regression()` to fit a linear regression model with the treatment, outcome, and correct adjustment set</span>

<span class="c1"># TODO use `fit_linear_regression()` to fit a linear regression model with the treatment, outcome, and incorrect adjustment set</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dag1_df</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dag1_df</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X2&#39;</span><span class="p">,</span> <span class="s1">&#39;X3&#39;</span><span class="p">,</span> <span class="s1">&#39;X1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dag1_df</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X2&#39;</span><span class="p">,</span> <span class="s1">&#39;X3&#39;</span><span class="p">,</span> <span class="s1">&#39;X1&#39;</span><span class="p">,</span> <span class="s1">&#39;X4&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept   -1.573796
T           -0.850804
dtype: float64
Intercept   -0.000254
T           -4.999949
X2           1.641962
X3           1.963934
X1           2.991947
dtype: float64
Intercept   -0.000034
T           -3.012448
X2           0.826133
X3           0.988126
X1           1.505270
X4           0.049689
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="id8">
<h2>3.2<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<p>Here is our second DAG:</p>
<p><img alt="" src="../_images/ws4_dag2.png" /></p>
<p>What is the estimated ATE if we fit a linear regression model with just the treatment and outcome?</p>
<p><strong>Your Response</strong>: The estimated ATE with only treatment as a covariate is 3.29.</p>
<p>What variable(s) should we not adjust for? Identify what kind of variable(s) they are (mediator, collider, or confounder).</p>
<p><strong>Your Response</strong>: To measure the total causal effect of T on Y, we should not adjust for X3 as it is a mediator.</p>
<p>There are now three possible adjustment sets that satisfy the backdoor criterion. Estimate the ATEs when including each of the three adjustment sets in your regression. Does your ATE estimate change much across the adjustment sets?</p>
<p><strong>Your Response</strong>:</p>
<ul class="simple">
<li><p>Adjustment set 1: X1, with an estimated ATE of 3.98.</p></li>
<li><p>Adjustment set 2: X2, with an estimated ATE of 4.01.</p></li>
<li><p>Adjustment set 3: X2, X1, with an estimated ATE of 4.00.</p></li>
</ul>
<p>The ATE estimates are similar across the adjustment sets, which suggests that the adjustment sets are all valid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag2_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;~/COMSC-341CD/data/ws4_dag2.csv&quot;</span><span class="p">)</span>

<span class="c1"># TODO use `fit_linear_regression()` to fit a linear regression model with just the treatment and outcome</span>

<span class="c1"># TODO use `fit_linear_regression()` to fit a linear regression model with the treatment, outcome, </span>
<span class="c1"># and the three possible adjustment sets</span>

<span class="c1">### BEGIN SOLUTION</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dag2_df</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dag2_df</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dag2_df</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_linear_regression</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dag2_df</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X2&#39;</span><span class="p">,</span> <span class="s1">&#39;X1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="c1">### END SOLUTION</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    1.505818
T            3.296440
dtype: float64
Intercept    1.006529
T            3.982600
X1          -0.607505
dtype: float64
Intercept    1.046136
T            4.014883
X2          -0.310225
dtype: float64
Intercept    1.055072
T            4.005916
X2          -0.322078
X1           0.032244
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">True treatment effects (click this once you’ve completed the section)</p>
<ul class="simple">
<li><p>For 3.1: -5</p></li>
<li><p>For 3.2: 4</p></li>
</ul>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="reading-austin-2011-1-pt">
<h1>4. Reading: Austin 2011 [1 pt]<a class="headerlink" href="#reading-austin-2011-1-pt" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Read the following sections of <a class="reference external" href="https://www.tandfonline.com/doi/pdf/10.1080/00273171.2011.568786">Austin 2011: “An Introduction to Propensity Score Methods for Causal Inference in Observational Studies”</a></p>
<ul>
<li><p>Abstract through the first two paragraphs of “Propensity Score Matching”, stopping at the paragraph that begins “Once the effect of treatment has been estimated…” (p399 - 404)</p></li>
</ul>
</li>
</ul>
<div class="admonition-reading-notes admonition">
<p class="admonition-title">Reading Notes</p>
<ul class="simple">
<li><p>This paper drove a lot of the popularity of propensity score methods in behavioral and psychological research – it has been cited almost 12,000 times!</p></li>
<li><p>Austin uses <span class="math notranslate nohighlight">\(Z\)</span> to denote the binary treatment indicator, while we use <span class="math notranslate nohighlight">\(T\)</span>.</p></li>
<li><p>This is also our first paper focused on technical methodology – don’t worry about all the details, particularly the statistical considerations. The goal with this reading is to help place propensity scores in the context of the observational study designs we have been looking at the past few lectures, and to provide a brief introduction to how propensity scores can be used. You will have the opportunity to build a matching estimator using propensity scores in Project 2.</p></li>
<li><p>Austin discusses the work of <a class="reference external" href="https://www.stat.cmu.edu/~ryantibs/journalclub/rosenbaum_1983.pdf">Rosenbaum and Rubin (1983)</a> on the propensity score. In particular, he describes the two assumptions needed for treatment assignment to be <strong>strongly ignorable</strong>, which you may recognize as our conditional exchangeability and positivity assumptions. Thus conditioning on the propensity score is equivalent to conditioning on the covariates that satisfy the backdoor criterion.</p></li>
</ul>
</div>
<p><strong>4.1</strong> In the “Potential Outcomes Framework and Average Treatment Effects” section (p401), Austin describes a new causal quantity called the <strong>ATT</strong>. State what the ATT is mathematically (using <span class="math notranslate nohighlight">\(T\)</span> instead of <span class="math notranslate nohighlight">\(Z\)</span>), describe what causal quantity it corresponds to.</p>
<p><strong>Your Response</strong>: The ATT is the average treatment effect for the treated units, which is given by <span class="math notranslate nohighlight">\(E[Y(1) - Y(0) | T=1]\)</span>.</p>
<p><strong>4.2</strong> In the “Observational Studies” section (p402), Austin states that “In observational studies, the treated subjects often differ systematically from
untreated subjects. I have that <span class="math notranslate nohighlight">\(E[Y(1) | T=1] \neq E[Y(1)]\)</span> (and similarly for the control treatment)”, substituting <span class="math notranslate nohighlight">\(T\)</span> for <span class="math notranslate nohighlight">\(Z\)</span> in the notation. Which assumption (among the ones we have discussed in class) does this mean that observational studies violate?</p>
<p><strong>Your Response</strong>: <span class="math notranslate nohighlight">\(E[Y(1) | T=1] \neq E[Y(1)]\)</span> (and analogously for the control group) indicates that exchangeability is violated, as <span class="math notranslate nohighlight">\(Y(1), Y(0) \not\perp T\)</span>. This means that the potential outcomes are not independent of the treatment assignment in an observational study.</p>
<p><strong>4.3</strong>: At the beginning of the “Propensity Score and Propensity Methods” section (starting on p402), Austin describes the propensity score as a “balancing score.” Explain what this means and why this property is important for causal inference in observational studies.</p>
<p><strong>Your Response</strong>: The propensity score is a balancing score because it balances the treatment and control groups on the covariates that satisfy conditional exchangeability/backdoor criterion. Conditional on the propensity score, the treatment and control groups are similar on the observed covariates. This allows us to estimate causal effects by comparing the treated and control groups on the outcome, controlling for the propensity score.</p>
<p><strong>4.4</strong>: Austin then discusses the work of Rosenbaum and Rubin (1983) on the propensity score. In particular, he describes the two assumptions needed for treatment assignment to be termed <strong>strongly ignorable</strong>. What are the mathematical statements of the two assumptions, and which assumptions do they correspond to among the ones we have discussed in class?</p>
<p><strong>Your Response</strong>:</p>
<p>The two mathematical statements and corresponding assumptions in Austin 2011 for strong ignorability are:</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(Y(1), Y(0) \perp T \mid X\)</span>, which is conditional exchangeability.</p></li>
<li><p><span class="math notranslate nohighlight">\( 0 &lt; P(T = 1 | X) &lt; 1\)</span>, which is positivity.</p></li>
</ol>
<p><strong>4.5</strong> In the “Propensity Score Matching” section (starting on p404), Austin describes 1:1 (or pair) matching as the most common implementation of propensity score matching. Explain the process of how these matched pairs are formed: what treatment assignments do the two units in a pair have, and what makes two units “similar” enough to be matched?</p>
<p><strong>Your Response</strong>: In 1:1 matching, each treated unit is matched with a control unit that has the closest propensity score. The two units are “similar” enough to be matched if they have smallest difference in the propensity score among the candidate control units to be matched.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="reflection-0-5-pts">
<h1>5. Reflection [0.5 pts]<a class="headerlink" href="#reflection-0-5-pts" title="Link to this heading">#</a></h1>
<p><strong>5.1</strong> How much time did it take you to complete this worksheet? How long did it take for you to complete the reading?</p>
<p><strong>Your Response</strong>: Varies</p>
<p><strong>5.2</strong> What is one thing you have a better understanding of after completing this worksheet and going through the class content this week? This could be about the concepts, the reading, or the code.</p>
<p><strong>Your Response</strong>: Varies</p>
<p><strong>5.3</strong> What questions or points of confusion do you have about the material covered covered in the past week of class?</p>
<p><strong>Your Response</strong>: Varies</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don’t forget to check that all of the TODOs are filled in before you submit!</p>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="acknowledgements">
<h1>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Regression widget exercise inspired by <a class="reference external" href="https://lbynum.github.io/interactive-causal-inference/">Bynum et al. 2022: An Interactive Introduction to Causal Inference</a></p></li>
</ul>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./worksheets"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">WS 4 Solution 📈</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#statsmodels-1-pt">1. Statsmodels [1 pt]</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-statsmodels-to-fit-linear-regression-models">Using statsmodels to fit linear regression models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">1.1</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-regression-coefficients">Interpreting regression coefficients</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">1.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">1.4</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-regression-for-treatment-effect-estimation-1-pt">2. Linear regression for treatment effect estimation [1 pt]</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2.2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#to-adjust-or-not-to-adjust-1-5-pts">3. To adjust or not to adjust? [1.5 pts]</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-austin-2011-1-pt">4. Reading: Austin 2011 [1 pt]</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reflection-0-5-pts">5. Reflection [0.5 pts]</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
  Causal Inference for Data Science is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>.
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>